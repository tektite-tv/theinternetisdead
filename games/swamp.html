<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Topo Camo Lava Lamp (Unhinged)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    canvas { display:block; width:100vw; height:100vh; touch-action:none; }
  </style>
</head>
<body>
<canvas id="c"></canvas>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });

  const buf = document.createElement('canvas');
  const bctx = buf.getContext('2d', { alpha:false });

  let DPR = 1, W = 0, H = 0, BW = 0, BH = 0;
  let imageData = null;

  let quality = 0.75;
  const MIN_Q = 0.45, MAX_Q = 1.0;

  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = innerWidth * DPR | 0;
    H = innerHeight * DPR | 0;
    canvas.width = W;
    canvas.height = H;

    BW = Math.max(220, W * quality | 0);
    BH = Math.max(220, H * quality | 0);
    buf.width = BW;
    buf.height = BH;
    imageData = bctx.createImageData(BW, BH);
  }
  addEventListener('resize', resize);
  resize();

  // Interaction
  let cxN = 0.5, cyN = 0.5, swirl = 0, stirX = 0, stirY = 0;
  let px = 0, py = 0, dragging = false;

  const pos = e =>
    e.touches ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : e;

  canvas.onmousedown = e => {
    dragging = true;
    px = e.clientX; py = e.clientY;
  };
  addEventListener('mousemove', e => {
    if(!dragging) return;
    const dx = e.clientX - px, dy = e.clientY - py;
    px = e.clientX; py = e.clientY;
    const m = Math.hypot(dx,dy)||1;
    stirX = stirX*0.7 + dx/m*0.3;
    stirY = stirY*0.7 + dy/m*0.3;
    swirl = Math.min(1, swirl + m/60);
    cxN = px/innerWidth;
    cyN = py/innerHeight;
  });
  addEventListener('mouseup', ()=>dragging=false);

  canvas.ontouchstart = e => {
    dragging = true;
    const p = pos(e);
    px = p.x; py = p.y;
  };
  canvas.ontouchmove = e => {
    e.preventDefault();
    const p = pos(e);
    const dx = p.x-px, dy = p.y-py;
    px=p.x; py=p.y;
    const m = Math.hypot(dx,dy)||1;
    stirX = stirX*0.7 + dx/m*0.3;
    stirY = stirY*0.7 + dy/m*0.3;
    swirl = Math.min(1, swirl + m/60);
    cxN = px/innerWidth;
    cyN = py/innerHeight;
  };
  canvas.ontouchend = ()=>dragging=false;

  // Noise
  const hash = n => ((n=(n^61)^(n>>>16),n+=n<<3,n^=n>>>4,n*=0x27d4eb2d,n^=n>>>15)>>>0)/4294967296;
  const lerp=(a,b,t)=>a+(b-a)*t;
  const smooth=t=>t*t*(3-2*t);

  function vnoise(x,y){
    const xi=x|0, yi=y|0;
    const xf=x-xi, yf=y-yi;
    const u=smooth(xf), v=smooth(yf);
    const a=hash(xi*374761393^yi*668265263);
    const b=hash((xi+1)*374761393^yi*668265263);
    const c=hash(xi*374761393^(yi+1)*668265263);
    const d=hash((xi+1)*374761393^(yi+1)*668265263);
    return lerp(lerp(a,b,u),lerp(c,d,u),v);
  }

  function fbm(x,y){
    let f=0, a=0.6, fr=1;
    for(let i=0;i<3;i++){
      f+=a*(vnoise(x*fr,y*fr)*2-1);
      fr*=2.03; a*=0.5;
    }
    return f;
  }

  // HSV helpers
  function rgb2hsv(r,g,b){
    r/=255; g/=255; b/=255;
    const m=Math.max(r,g,b), n=Math.min(r,g,b), d=m-n;
    let h=0;
    if(d){
      if(m===r) h=((g-b)/d)%6;
      else if(m===g) h=(b-r)/d+2;
      else h=(r-g)/d+4;
      h/=6; if(h<0)h+=1;
    }
    return [h, m?d/m:0, m];
  }

  function hsv2rgb(h,s,v){
    const i=(h*6)|0;
    const f=h*6-i;
    const p=v*(1-s);
    const q=v*(1-f*s);
    const t=v*(1-(1-f)*s);
    const mod=i%6;
    const r=[v,q,p,p,t,v][mod];
    const g=[t,v,v,q,p,p][mod];
    const b=[p,p,t,v,v,q][mod];
    return [r*255,g*255,b*255];
  }

  let last=performance.now(), avg=16;

  function frame(t){
    const dt=t-last; last=t;
    avg=avg*0.9+dt*0.1;
    if(avg>20&&quality>MIN_Q){quality-=0.05;resize();}
    if(avg<15&&quality<MAX_Q){quality+=0.02;resize();}

    stirX*=0.94; stirY*=0.94; swirl*=0.93;

    const time=t*0.001;
    const d=imageData.data;
    const cx=cxN*BW, cy=cyN*BH;
    const scale=0.018;
    const hueShift=time*0.08;
    const rgbShift=Math.sin(time*1.3)*1.5;

    let i=0;
    for(let y=0;y<BH;y++){
      for(let x=0;x<BW;x++){
        const dx=x-cx, dy=y-cy;
        const sw=swirl*200/(Math.hypot(dx,dy)+20);
        const wx=x-dy*sw+stirX*24;
        const wy=y+dx*sw+stirY*24;

        const nx=wx*scale, ny=wy*scale;
        let h=fbm(nx*1.2+time*0.15,ny*1.2-time*0.1)*0.5+0.5;
        h=Math.min(1,Math.max(0,h));

        let r=lerp(30,120,h);
        let g=lerp(60,180,h);
        let b=lerp(40,90,h);

        let [hh,ss,vv]=rgb2hsv(r,g,b);
        hh=(hh+hueShift+h*0.2)%1;
        ss=Math.min(1,ss*1.8);
        [r,g,b]=hsv2rgb(hh,ss,vv);

        d[i++]=r;
        d[i++]=g;
        d[i++]=b;
        d[i++]=255;
      }
    }

    bctx.putImageData(imageData,0,0);

    ctx.clearRect(0,0,W,H);
    ctx.drawImage(buf, rgbShift, 0, W, H);
    ctx.globalCompositeOperation="screen";
    ctx.drawImage(buf, -rgbShift, 0, W, H);
    ctx.globalCompositeOperation="source-over";

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
