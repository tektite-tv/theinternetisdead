<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bananaman Shooter v0.4.6</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* === v0.4.6 CHANGES ===
     + Added death overlay with fade-in red background and reset button
     + Overlay appears when player.hp <= 0 in die()
     + Restart button returns to main menu and resets state safely
  */
  html,body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:sans-serif;height:100%;}
  canvas{display:block;position:fixed;inset:0;}
  .hud{position:fixed;background:rgba(20,20,20,.7);border:1px solid rgba(255,255,255,.2);
    border-radius:8px;padding:6px 10px;font-size:14px;z-index:999;}
  #healthbar{position:fixed;bottom:5vh;left:50%;transform:translateX(-50%);
    width:60vw;height:20px;border:2px solid #fff;border-radius:10px;background:#400;z-index:1000;}
  #healthfill{background:#f33;width:100%;height:100%;border-radius:10px;transition:width .2s linear;}
  #healthtext{position:absolute;width:100%;top:0;text-align:center;font-size:12px;}

  /* === v0.4.6 additions: death overlay === */
  #deathOverlay {
    position:fixed; inset:0;
    background:rgba(150,0,0,0);
    color:#ff3333;
    font-size:5rem;
    font-weight:bold;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    opacity:0;
    transition:background 1s ease, opacity 1s ease;
    z-index:10000;
    pointer-events:none;
  }
  #deathOverlay.visible {
    background:rgba(150,0,0,0.6);
    opacity:1;
    pointer-events:auto;
  }
  #deathOverlay button {
    margin-top:1rem;
    background:#ff3333;
    color:#fff;
    border:none;
    padding:0.8rem 1.6rem;
    border-radius:8px;
    font-size:1.2rem;
    cursor:pointer;
    transition:background 0.3s;
  }
  #deathOverlay button:hover {background:#ff6666;}
</style>
</head>
<body>
<canvas id="bg"></canvas>
<canvas id="game"></canvas>

<!-- HUD -->
<div id="hud-stats" class="hud" style="top:10px;left:10px;">Kills: <span id="kills">0</span> | Wave: <span id="wave">0</span></div>
<div id="hud-top" class="hud" style="top:10px;right:10px;display:flex;gap:10px;">
  <div>Damage: <span id="damage">0</span></div>
  <div>Time: <span id="timer">0s</span></div>
</div>
<div id="healthbar"><div id="healthfill"></div><div id="healthtext">100%</div></div>

<!-- MENU -->
<div id="menu" class="fixed inset-0 flex flex-col items-center justify-center text-center bg-black/70 z-[9999]">
  <h1 class="text-5xl text-yellow-300 font-bold mb-4 drop-shadow-lg">Bananaman Shooter</h1>
  <button id="start" class="bg-yellow-400 text-black px-6 py-3 rounded-lg m-2 hover:bg-yellow-300 shadow-lg">Start Game</button>
  <p class="text-sm text-gray-400 mt-2 italic">v0.4.6 â€” [WASD] move, [Click] shoot</p>
</div>

<!-- === v0.4.6: Death Overlay === -->
<div id="deathOverlay">
  <div>You Died</div>
  <button id="restartBtn">Return to Main Menu</button>
</div>

<script>
/* === v0.4.6: Additions include death overlay + restart handling === */

const bg=document.getElementById('bg');
const g=bg.getContext('2d');
const game=document.getElementById('game');
const ctx=game.getContext('2d');
let W=innerWidth,H=innerHeight;
bg.width=game.width=W;bg.height=game.height=H;
addEventListener('resize',()=>{W=innerWidth;H=innerHeight;bg.width=game.width=W;bg.height=game.height=H;});

// === GRID ===
let gridOffsetX=0,gridOffsetY=0,gridSpacing=40,gridStatic=true;
function drawGrid(){
  g.clearRect(0,0,W,H);
  g.strokeStyle='rgba(0,255,150,0.4)';
  g.shadowColor='#00ffaa';
  g.shadowBlur=gridStatic?4:10;
  g.lineWidth=1.2;
  g.beginPath();
  for(let x=-gridSpacing;x<W+gridSpacing;x+=gridSpacing){
    g.moveTo(x+gridOffsetX%gridSpacing,0);
    g.lineTo(x+gridOffsetX%gridSpacing,H);
  }
  for(let y=-gridSpacing;y<H+gridSpacing;y+=gridSpacing){
    g.moveTo(0,y+gridOffsetY%gridSpacing);
    g.lineTo(W,y+gridOffsetY%gridSpacing);
  }
  g.stroke();
}

// === SPRITES & AUDIO (unchanged) ===
const enemyGifs=[
 'bananarama.gif','dancing-guy.gif','dancingzoidberg.gif','dragon.gif','eyes.gif',
 'fatspiderman.gif','firework.gif','frog.gif','keyboard_smash.gif','skeleton.gif'
].map(n=>`/media/images/gifs/${n}`);
const playerImg=new Image();playerImg.src='/media/images/gifs/bananarama.gif';
let playerLoaded=false;playerImg.onload=()=>playerLoaded=true;

const hitSound = new Audio('/media/audio/hitmarker.mp3');
function playHitSound(){const s=hitSound.cloneNode();s.volume=0.4;s.play().catch(()=>{});}
const oofSound = new Audio('/media/audio/oof.mp3');
function playOof(){const s=oofSound.cloneNode();s.playbackRate=0.9+Math.random()*0.2;s.play().catch(()=>{});}
const bgMusic = new Audio('/media/audio/spaceinvaders.mp3');bgMusic.loop=true;bgMusic.volume=0.6;

// === STATE ===
const player={x:W/2,y:H/2,size:96,hp:100,speed:280,hitTimer:0,invuln:0};
const bullets=[],enemies=[];
let kills=0,wave=1,damage=0,startTime=null,state='menu',keys={},mouse={x:W/2,y:H/2};

// === HUD ===
const killsEl=document.getElementById('kills'),waveEl=document.getElementById('wave'),
damageEl=document.getElementById('damage'),timerEl=document.getElementById('timer'),
healthFill=document.getElementById('healthfill'),healthText=document.getElementById('healthtext'),
menu=document.getElementById('menu'),deathOverlay=document.getElementById('deathOverlay'),
restartBtn=document.getElementById('restartBtn');

function updateHealth(){const pct=Math.max(0,Math.round(player.hp));healthFill.style.width=pct+'%';healthText.textContent=pct+'%';}
function updateHUD(){killsEl.textContent=kills;waveEl.textContent=wave;damageEl.textContent=damage;timerEl.textContent=((performance.now()-startTime)/1000).toFixed(1)+'s';}

// === PLAYER / ENEMIES / COMBAT unchanged from v0.4.5 ===
// (omitted here for brevity; identical logic to previous version)

function applyDamage(dmg){
  player.hp=Math.max(0,player.hp-dmg);
  player.hitTimer=0.3;
  player.invuln=0.3;
  playOof();
  updateHealth();
  if(player.hp<=0)die();
}

// === v0.4.6: die() updated to show overlay ===
function die(){
  state='dead';
  bgMusic.pause();
  bgMusic.currentTime=0;
  gridStatic=true;
  drawGrid();
  deathOverlay.classList.add('visible'); // show overlay
}

// === v0.4.6: Restart button logic ===
restartBtn.onclick=()=>{
  deathOverlay.classList.remove('visible');
  menu.style.display='flex';
  player.hp=100;updateHealth();
  enemies.length=0;bullets.length=0;
  kills=0;wave=1;damage=0;
  gridStatic=true;
  drawGrid();
  state='menu';
};

// === START ===
document.getElementById('start').onclick=()=>{
  menu.style.display='none';
  gridStatic=false;
  bgMusic.currentTime=0; bgMusic.play().catch(()=>{});
  kills=0; wave=1; damage=0; player.hp=100; updateHealth();
  bullets.length=0; enemies.length=0; /* spawnWave() etc. */
  startTime=performance.now(); state='playing'; loop();
};

// Draw static grid
gridStatic=true;
drawGrid();
</script>
</body>
</html>
