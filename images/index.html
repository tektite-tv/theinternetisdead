<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>theinternetisdead.org â€” Images</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --fg: #f2f2f2;
      --muted: #a1a1a1;
      --accent: #00ff99;
      --card: #141414;
      --border: #262626;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    /* Taskbar */
    .taskbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.8));
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(6px);
    }
    .taskbar .title {
      font-weight: 600;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }
    .taskbar .spacer { flex: 1; }
    .taskbtn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .taskbtn:active { transform: translateY(1px); }

    .clock { font-variant-numeric: tabular-nums; color: var(--muted); }

    main { padding: 16px; max-width: 1200px; margin: 0 auto; }

    /* Grid */
    #grid {
      display: grid;
      grid-template-columns: repeat( auto-fill, minmax(180px, 1fr) );
      gap: 12px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .thumb {
      display: block;
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #000;
      cursor: pointer;
    }
    .meta { display: flex; align-items: center; justify-content: space-between; padding: 8px; }
    .name { color: var(--muted); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .dl {
      text-decoration: none; font-size: 12px; padding: 4px 8px; border: 1px solid var(--border);
      border-radius: 999px; color: var(--fg); background: transparent;
    }

    #emptyMsg { display: none; color: var(--muted); text-align: center; margin: 24px 0; }

    /* Lightbox */
    .lightbox {
      position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,0.85);
      z-index: 2000; padding: 24px; backdrop-filter: blur(2px);
    }
    .lightbox.open { display: grid; }
    .lightbox-inner { max-width: min(92vw, 1400px); max-height: 86vh; width: 100%; }
    .lightbox-figure { margin: 0; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .lightbox-img { display: block; width: 100%; height: auto; max-height: 80vh; object-fit: contain; }
    .lightbox-bar { display: flex; gap: 8px; align-items: center; justify-content: space-between; padding-top: 8px; }
    .lightbox-controls { display: flex; gap: 8px; }
    .btn {
      border: 1px solid var(--border); background: var(--card); color: var(--fg); padding: 8px 12px;
      border-radius: 10px; font-weight: 600; cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }
    .srcname { color: var(--muted); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    @media (max-width: 480px) {
      .thumb { height: 140px; }
      .lightbox-inner { max-width: 96vw; max-height: 84vh; }
    }
  </style>
</head>
<body>
  <header class="taskbar">
    <div class="title">welcome to theinternetisdead.org â€” images</div>
    <div class="spacer"></div>
    <button class="taskbtn" id="refreshBtn" type="button" title="Reload images">ðŸ”„ Refresh</button>
    <div class="clock" id="clock"></div>
  </header>

  <main>
    <p id="emptyMsg">No images found. Add files to <code>/images/</code> and entries to <code>/images/index.json</code>.</p>
    <section id="grid" aria-live="polite"></section>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
    <div class="lightbox-inner">
      <figure class="lightbox-figure">
        <img id="lbImg" class="lightbox-img" alt="" />
      </figure>
      <div class="lightbox-bar">
        <div class="srcname" id="lbName"></div>
        <div class="lightbox-controls">
          <a id="lbDownload" class="btn" download>Download</a>
          <button id="lbClose" class="btn" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Track rendered images to prevent duplicates across refreshes
    const rendered = new Set();

    function makeCard(item) {
      const fig = document.createElement('figure');
      fig.className = 'card';

      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = item.src;
      img.alt = item.alt || '';
      img.addEventListener('click', () => openLightbox(item.src));

      const meta = document.createElement('figcaption');
      meta.className = 'meta';
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = (item.name || item.src).replace(/^.*\//, '');
      const dl = document.createElement('a');
      dl.className = 'dl';
      dl.href = item.src;
      dl.download = '';
      dl.textContent = 'Download';

      meta.appendChild(name);
      meta.appendChild(dl);
      fig.appendChild(img);
      fig.appendChild(meta);
      return fig;
    }

    function initLightbox() {
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lbImg');
      const lbName = document.getElementById('lbName');
      const lbDl = document.getElementById('lbDownload');
      const lbClose = document.getElementById('lbClose');

      lb.addEventListener('click', (e) => {
        if (e.target === lb) closeLightbox();
      });
      lbClose.addEventListener('click', closeLightbox);

      function closeLightbox() { lb.classList.remove('open'); }

      window.openLightbox = function (src) {
        lbImg.src = src;
        lbName.textContent = src.replace(/^.*\//, '');
        lbDl.href = src;
        lb.classList.add('open');
      };
      window.closeLightbox = closeLightbox;
    }

    async function loadImages(opts = { clear: false, bust: false }) {
      const grid = document.getElementById('grid');
      const emptyMsg = document.getElementById('emptyMsg');

      if (opts.clear) {
        grid.innerHTML = '';
        emptyMsg.style.display = 'none';
        rendered.clear();
      }

      const baseCandidates = ['/images/index.json', '/images/_manifest.json', '/images/manifest.json'];
      const stamp = opts.bust ? ('?v=' + Date.now()) : '';
      const candidates = baseCandidates.map(u => u + stamp);

      let data = null;
      for (const url of candidates) {
        try {
          const r = await fetch(url, { cache: 'no-cache' });
          if (r.ok) { data = await r.json(); break; }
        } catch (_) { /* ignore and try next */ }
      }

      if (!data) {
        emptyMsg.style.display = 'block';
        return;
      }

      // Normalize possible shapes
      let items = [];
      if (Array.isArray(data)) {
        items = data.map(x => typeof x === 'string' ? { src: '/images/' + x } : x);
      } else if (Array.isArray(data.images)) {
        items = data.images.map(x => typeof x === 'string' ? { src: '/images/' + x } : x);
      } else if (typeof data === 'object') {
        items = Object.keys(data).map(k => ({ src: '/images/' + k, ...(typeof data[k] === 'object' ? data[k] : {}) }));
      }

      const ok = /\.(png|jpe?g|gif|webp|bmp|svg|avif)$/i;
      items = items
        .map(it => {
          const src = it.src?.startsWith('/images/') ? it.src : ('/images/' + it.src);
          return { ...it, src };
        })
        .filter(it => ok.test(it.src));

      if (items.length === 0) { emptyMsg.style.display = 'block'; return; }

      const frag = document.createDocumentFragment();
      for (const it of items) {
        if (rendered.has(it.src)) continue;
        frag.appendChild(makeCard(it));
        rendered.add(it.src);
      }
      grid.appendChild(frag);
    }

    function startClock() {
      const el = document.getElementById('clock');
      const fmt = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const tick = () => { el.textContent = fmt.format(new Date()); };
      tick();
      setInterval(tick, 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initLightbox();
      startClock();
      loadImages(); // initial load without bust

      document.getElementById('refreshBtn')?.addEventListener('click', () => {
        loadImages({ clear: true, bust: true });
      });
    });
  </script>
</body>
</html>
